generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Provider {
  id                    String                 @id @default(cuid())
  name                  String
  slug                  String                 @unique
  phone                 String?
  phonePublic           String?
  email                 String?
  website               String?
  bookingUrl            String?
  description           String?
  rating                Float?
  reviewsCount          Int?
  featured              Boolean                @default(false)
  status                ProviderStatus         @default(UNVERIFIED)
  isFeatured            Boolean                @default(false)
  featuredTier          FeaturedTier?
  stripeCustomerId      String?
  claimEmail            String?
  claimToken            String?
  claimVerifiedAt       DateTime?
  twilioNumber          String?
  zipCodes              String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  affiliateLink         String?
  isFeaturedCity        Boolean                @default(false)
  listingTier           ListingTier            @default(BASIC)
  serviceZipCodes       String?
  stripePaymentMethodId String?
  eligibleForLeads      Boolean                @default(false)
  trialExpiresAt        DateTime?
  trialStartedAt        DateTime?
  trialStatus           TrialStatus            @default(NONE)
  operatingDays         String?
  operatingHoursEnd     String?
  operatingHoursStart   String?
  serviceRadiusMiles    Int?
  logo                  String?
  profileImage          String?
  notificationEmail     String?
  notifyEnabled         Boolean                @default(true)
  primaryCity           String?
  primaryCitySlug       String?
  primaryMetro          String?
  primaryState          String?
  primaryStateName      String?
  primaryStateSlug      String?
  lastSMSSentAt         DateTime?
  smsOptInAt            DateTime?
  smsOptOutAt           DateTime?
  smsOptOutReason       String?
  callLogs              CallLog[]
  leadNotifications     LeadNotification[]
  leads                 Lead[]
  address               ProviderAddress?
  availability          ProviderAvailability[]
  badges                ProviderBadge[]
  coords                ProviderCoords?
  corrections           ProviderCorrection[]
  correctionsQueue      ProviderCorrections[]  @relation("corrections_queue")
  coverage              ProviderCoverage[]
  payment               ProviderPayment[]
  services              ProviderService[]

  @@index([primaryState])
  @@index([primaryCity])
  @@index([primaryMetro])
  @@map("providers")
}

model Lead {
  id                String             @id @default(cuid())
  createdAt         DateTime           @default(now())
  fullName          String
  phone             String
  email             String?
  address1          String?
  city              String
  state             String
  zip               String
  urgency           Urgency
  notes             String?
  source            String
  gclid             String?
  routedToId        String?
  routedAt          DateTime?
  priceCents        Int
  status            LeadStatus         @default(NEW)
  labPreference     String             @default("Other/Unsure")
  claimedAt         DateTime?
  firstContactAt    DateTime?
  callAttempts      Int                @default(0)
  outcome           LeadOutcome?
  outcomeNotes      String?
  appointmentDate   DateTime?
  completedAt       DateTime?
  providerNotes     String?
  leadNotifications LeadNotification[]
  provider          Provider?          @relation(fields: [routedToId], references: [id])

  @@map("leads")
}

model CallLog {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  fromNumber   String
  toNumber     String
  durationSec  Int?
  callStatus   String?
  city         String?
  state        String?
  zip          String?
  providerId   String?
  recordingUrl String?
  leadId       String?
  callSid      String?   @unique
  provider     Provider? @relation(fields: [providerId], references: [id])

  @@map("call_logs")
}

model CityNumber {
  id           String  @id @default(cuid())
  city         String
  state        String
  twilioNumber String  @unique
  providerId   String?

  @@map("city_numbers")
}

model Service {
  id        String            @id @default(cuid())
  name      String            @unique
  providers ProviderService[]

  @@map("services")
}

model ProviderService {
  id         String   @id @default(cuid())
  providerId String
  serviceId  String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service    Service  @relation(fields: [serviceId], references: [id])

  @@unique([providerId, serviceId])
  @@map("provider_services")
}

model State {
  id       String             @id @default(cuid())
  name     String             @unique
  abbr     String             @unique
  cities   City[]
  coverage ProviderCoverage[]

  @@map("states")
}

model City {
  id       String             @id @default(cuid())
  name     String
  stateId  String
  slug     String
  state    State              @relation(fields: [stateId], references: [id])
  coverage ProviderCoverage[]

  @@unique([name, stateId])
  @@map("cities")
}

model ProviderCoverage {
  id         String   @id @default(cuid())
  providerId String
  stateId    String
  cityId     String?
  city       City?    @relation(fields: [cityId], references: [id])
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  state      State    @relation(fields: [stateId], references: [id])

  @@unique([providerId, stateId, cityId])
  @@map("provider_coverage")
}

model ProviderAddress {
  id         String   @id @default(cuid())
  providerId String   @unique
  street     String?
  city       String?
  state      String?
  zip        String?
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_addresses")
}

model ProviderCoords {
  id         String   @id @default(cuid())
  providerId String   @unique
  lat        Float
  lng        Float
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_coords")
}

model Availability {
  id        String                 @id @default(cuid())
  name      String                 @unique
  providers ProviderAvailability[]

  @@map("availability")
}

model ProviderAvailability {
  id             String       @id @default(cuid())
  providerId     String
  availabilityId String
  availability   Availability @relation(fields: [availabilityId], references: [id])
  provider       Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, availabilityId])
  @@map("provider_availability")
}

model Payment {
  id        String            @id @default(cuid())
  name      String            @unique
  providers ProviderPayment[]

  @@map("payments")
}

model ProviderPayment {
  id         String   @id @default(cuid())
  providerId String
  paymentId  String
  payment    Payment  @relation(fields: [paymentId], references: [id])
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, paymentId])
  @@map("provider_payments")
}

model Badge {
  id        String          @id @default(cuid())
  name      String          @unique
  providers ProviderBadge[]

  @@map("badges")
}

model ProviderBadge {
  id         String   @id @default(cuid())
  providerId String
  badgeId    String
  badge      Badge    @relation(fields: [badgeId], references: [id])
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, badgeId])
  @@map("provider_badges")
}

model ProviderCorrection {
  id            String           @id @default(cuid())
  createdAt     DateTime         @default(now())
  providerId    String
  reporterName  String?
  reporterEmail String?
  issueType     String
  description   String
  status        CorrectionStatus @default(PENDING)
  reviewedAt    DateTime?
  reviewNotes   String?
  provider      Provider         @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_corrections")
}

model ProviderCorrections {
  id           String                @id @default(cuid())
  providerId   String?
  urlSlug      String
  note         String
  contactEmail String?
  createdAt    DateTime              @default(now())
  handledAt    DateTime?
  handledBy    String?
  status       CorrectionQueueStatus @default(OPEN)
  provider     Provider?             @relation("corrections_queue", fields: [providerId], references: [id])

  @@map("provider_corrections_queue")
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  zipCode   String?
  source    String
  createdAt DateTime @default(now())
  notified  Boolean  @default(false)

  @@map("waitlist")
}

model PendingSubmission {
  id                 String           @id @default(cuid())
  submittedAt        DateTime         @default(now())
  status             SubmissionStatus @default(PENDING)
  businessName       String
  contactName        String
  email              String
  phone              String
  website            String?
  description        String
  address            String?
  city               String
  state              String
  zipCode            String?
  serviceArea        String?
  yearsExperience    String?
  licensed           Boolean          @default(false)
  insurance          Boolean          @default(false)
  certifications     String?
  specialties        String?
  emergencyAvailable Boolean          @default(false)
  weekendAvailable   Boolean          @default(false)
  logo               String?
  ipAddress          String?
  userAgent          String?
  leadOptIn          String?
  leadContactMethod  String?
  leadEmail          String?
  leadPhone          String?
  availability       String?

  @@map("pending_submissions")
}

model CorporateEventInquiry {
  id                     String                 @id @default(cuid())
  createdAt              DateTime               @default(now())
  companyName            String
  contactName            String
  email                  String
  phone                  String
  eventLocation          String
  eventVenue             String?
  eventDates             String
  estimatedDraws         String
  estimatedPhlebotomists String?
  eventType              String
  additionalDetails      String?
  status                 CorporateInquiryStatus @default(NEW)
  ipAddress              String?
  userAgent              String?
  urgency                String?

  @@map("corporate_event_inquiries")
}

model LeadNotification {
  id           String             @id @default(cuid())
  leadId       String
  providerId   String
  channel      String             @default("email")
  status       NotificationStatus @default(QUEUED)
  errorMessage String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  sentAt       DateTime?
  lead         Lead               @relation(fields: [leadId], references: [id], onDelete: Cascade)
  provider     Provider           @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([providerId])
  @@map("lead_notifications")
}

enum ProviderStatus {
  UNVERIFIED
  PENDING
  VERIFIED
}

enum FeaturedTier {
  FOUNDING_PARTNER
  STANDARD_PREMIUM
  HIGH_DENSITY
}

enum LeadStatus {
  NEW
  DELIVERED
  REFUNDED
  UNSOLD
  OPEN
  CLAIMED
}

enum LeadOutcome {
  CONTACTED
  APPOINTMENT_BOOKED
  APPOINTMENT_COMPLETED
  NO_ANSWER
  VOICEMAIL
  DECLINED
  WRONG_NUMBER
  DUPLICATE
  NOT_INTERESTED
  SCHEDULED_CALLBACK
  OUTSIDE_SERVICE_AREA
  NO_AVAILABILITY
  WRONG_SERVICE
}

enum Urgency {
  STANDARD
  STAT
}

enum CorrectionStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum CorrectionQueueStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CorporateInquiryStatus {
  NEW
  CONTACTED
  QUOTED
  BOOKED
  COMPLETED
  DECLINED
}

enum ListingTier {
  BASIC
  PREMIUM
  FEATURED
}

enum TrialStatus {
  NONE
  ACTIVE
  EXPIRED
}

enum NotificationStatus {
  QUEUED
  SENT
  FAILED
}
