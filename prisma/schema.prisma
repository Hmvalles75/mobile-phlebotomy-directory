// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Provider {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  phone        String?  // legacy field
  phonePublic  String?  // shown only with "Unverified" badge + disclaimer
  email        String?  // legacy, hidden from public
  website      String?
  bookingUrl   String?
  description  String?
  rating       Float?
  reviewsCount Int?
  featured     Boolean  @default(false)  // legacy field

  // Lead-gen fields
  status          ProviderStatus @default(UNVERIFIED)
  isFeatured      Boolean @default(false)
  featuredTier    FeaturedTier?
  stripeCustomerId String?
  leadCredit      Int      @default(0)
  claimEmail      String?  // email used after claim (hidden on public page)
  claimToken      String?  // for email verify
  claimVerifiedAt DateTime?
  twilioNumber    String?  // dedicated tracking number
  zipCodes        String?  // comma-separated service coverage ZIPs

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  services     ProviderService[]
  coverage     ProviderCoverage[]
  address      ProviderAddress?
  coords       ProviderCoords?
  availability ProviderAvailability[]
  payment      ProviderPayment[]
  badges       ProviderBadge[]
  leads        Lead[]
  callLogs     CallLog[]
  corrections  ProviderCorrection[]
  correctionsQueue ProviderCorrections[] @relation("corrections_queue")

  @@map("providers")
}

enum ProviderStatus {
  UNVERIFIED
  PENDING
  VERIFIED
}

enum FeaturedTier {
  SMALL
  MEDIUM
  LARGE
}

model Lead {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  fullName      String
  phone         String
  email         String?
  address1      String?
  city          String
  state         String
  zip           String
  urgency       Urgency
  notes         String?
  source        String   // "web_form" | "call"
  gclid         String?  // future
  routedToId    String?
  routedAt      DateTime?
  priceCents    Int
  status        LeadStatus @default(NEW)

  provider      Provider? @relation(fields: [routedToId], references: [id])

  @@map("leads")
}

enum LeadStatus {
  NEW
  DELIVERED
  REFUNDED
  UNSOLD
}

enum Urgency {
  STANDARD
  STAT
}

model CallLog {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  fromNumber    String
  toNumber      String
  durationSec   Int?
  callStatus    String?
  city          String?
  state         String?
  zip           String?
  providerId    String?
  recordingUrl  String?
  leadId        String?
  callSid       String?  @unique

  provider      Provider? @relation(fields: [providerId], references: [id])

  @@map("call_logs")
}

model CityNumber {
  id          String   @id @default(cuid())
  city        String
  state       String
  twilioNumber String  @unique
  providerId  String?

  @@map("city_numbers")
}

model Service {
  id   String @id @default(cuid())
  name String @unique
  
  providers ProviderService[]

  @@map("services")
}

model ProviderService {
  id         String   @id @default(cuid())
  providerId String
  serviceId  String
  
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service    Service  @relation(fields: [serviceId], references: [id])

  @@unique([providerId, serviceId])
  @@map("provider_services")
}

model State {
  id   String @id @default(cuid())
  name String @unique
  abbr String @unique

  coverage ProviderCoverage[]
  cities   City[]

  @@map("states")
}

model City {
  id      String @id @default(cuid())
  name    String
  stateId String
  slug    String

  state    State              @relation(fields: [stateId], references: [id])
  coverage ProviderCoverage[]

  @@unique([name, stateId])
  @@map("cities")
}

model ProviderCoverage {
  id         String  @id @default(cuid())
  providerId String
  stateId    String
  cityId     String?
  
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  state      State    @relation(fields: [stateId], references: [id])
  city       City?    @relation(fields: [cityId], references: [id])

  @@unique([providerId, stateId, cityId])
  @@map("provider_coverage")
}

model ProviderAddress {
  id         String  @id @default(cuid())
  providerId String  @unique
  street     String?
  city       String?
  state      String?
  zip        String?
  
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_addresses")
}

model ProviderCoords {
  id         String  @id @default(cuid())
  providerId String  @unique
  lat        Float
  lng        Float
  
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_coords")
}

model Availability {
  id   String @id @default(cuid())
  name String @unique
  
  providers ProviderAvailability[]

  @@map("availability")
}

model ProviderAvailability {
  id             String @id @default(cuid())
  providerId     String
  availabilityId String
  
  provider       Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  availability   Availability @relation(fields: [availabilityId], references: [id])

  @@unique([providerId, availabilityId])
  @@map("provider_availability")
}

model Payment {
  id   String @id @default(cuid())
  name String @unique
  
  providers ProviderPayment[]

  @@map("payments")
}

model ProviderPayment {
  id        String @id @default(cuid())
  providerId String
  paymentId String
  
  provider  Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  payment   Payment  @relation(fields: [paymentId], references: [id])

  @@unique([providerId, paymentId])
  @@map("provider_payments")
}

model Badge {
  id   String @id @default(cuid())
  name String @unique
  
  providers ProviderBadge[]

  @@map("badges")
}

model ProviderBadge {
  id        String @id @default(cuid())
  providerId String
  badgeId   String

  provider  Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([providerId, badgeId])
  @@map("provider_badges")
}

model ProviderCorrection {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  providerId    String
  reporterName  String?
  reporterEmail String?
  issueType     String   // "phone" | "address" | "hours" | "closed" | "other"
  description   String
  status        CorrectionStatus @default(PENDING)
  reviewedAt    DateTime?
  reviewNotes   String?

  provider      Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_corrections")
}

enum CorrectionStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

// Admin-facing corrections queue (alternative structure)
model ProviderCorrections {
  id          String   @id @default(cuid())
  providerId  String?
  provider    Provider? @relation("corrections_queue", fields: [providerId], references: [id])
  urlSlug     String   // fallback when providerId unknown
  note        String
  contactEmail String?
  createdAt   DateTime @default(now())
  handledAt   DateTime?
  handledBy   String?
  status      CorrectionQueueStatus @default(OPEN)

  @@map("provider_corrections_queue")
}

enum CorrectionQueueStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String   // "COMING_SOON_PAGE" | "FOOTER" | "OTHER"
  createdAt DateTime @default(now())
  notified  Boolean  @default(false)

  @@map("waitlist")
}

model PendingSubmission {
  id                  String   @id @default(cuid())
  submittedAt         DateTime @default(now())
  status              SubmissionStatus @default(PENDING)

  // Business Information
  businessName        String
  contactName         String
  email               String
  phone               String
  website             String?
  description         String

  // Location
  address             String?
  city                String
  state               String
  zipCode             String?
  serviceArea         String?

  // Professional Details
  yearsExperience     String?
  licensed            Boolean  @default(false)
  insurance           Boolean  @default(false)
  certifications      String?
  specialties         String?

  // Availability
  emergencyAvailable  Boolean  @default(false)
  weekendAvailable    Boolean  @default(false)

  // Optional
  logo                String?

  // Metadata
  ipAddress           String?
  userAgent           String?

  @@map("pending_submissions")
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

model CorporateEventInquiry {
  id                      String   @id @default(cuid())
  createdAt               DateTime @default(now())

  // Company Information
  companyName             String
  contactName             String
  email                   String
  phone                   String

  // Event Details
  eventLocation           String   // city, state
  eventVenue              String?
  eventDates              String   // flexible text field for dates
  estimatedDraws          String   // can be a range like "50-100"
  estimatedPhlebotomists  String?  // optional estimate
  eventType               String   // can store comma-separated or JSON array
  additionalDetails       String?  // textarea

  // Metadata
  status                  CorporateInquiryStatus @default(NEW)
  ipAddress               String?
  userAgent               String?

  @@map("corporate_event_inquiries")
}

enum CorporateInquiryStatus {
  NEW
  CONTACTED
  QUOTED
  BOOKED
  COMPLETED
  DECLINED
}
